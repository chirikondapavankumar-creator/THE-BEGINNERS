<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CodeRefine — Elite Java Optimizer</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@300;400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:       #070810;
  --bg2:      #0c0d1a;
  --bg3:      #0f1020;
  --border:   rgba(255,255,255,0.07);
  --bh:       rgba(255,255,255,0.13);
  --gold:     #c9a84c;
  --gold2:    #e8cc80;
  --blue:     #60a5fa;
  --green:    #34d399;
  --purple:   #a78bfa;
  --red:      #f87171;
  --orange:   #fb923c;
  --cyan:     #67e8f9;
  --text:     #f1f3ff;
  --text2:    #8892b0;
  --text3:    #3d4466;
  --error:    #ff6b6b;
}

html { scroll-behavior: smooth; }
body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed; inset: 0;
  background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 0;
}

.amb { position: fixed; pointer-events: none; z-index: 0; border-radius: 50%; filter: blur(1px); }
.amb-1 { top: -20%; left: 50%; transform: translateX(-50%); width: 1000px; height: 700px; background: radial-gradient(ellipse, rgba(96,165,250,0.07) 0%, transparent 65%); }
.amb-2 { bottom: -15%; right: -10%; width: 700px; height: 600px; background: radial-gradient(ellipse, rgba(201,168,76,0.07) 0%, transparent 65%); }
.amb-3 { top: 35%; left: -15%; width: 600px; height: 500px; background: radial-gradient(ellipse, rgba(167,139,250,0.04) 0%, transparent 65%); }

.wrap { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 0 2rem; }

header {
  padding: 1.4rem 0;
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 200;
  backdrop-filter: blur(28px) saturate(1.4);
  background: rgba(7,8,16,0.82);
}

.nav { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
.brand { display: flex; align-items: center; gap: 0.85rem; text-decoration: none; }

.brand-icon {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, rgba(201,168,76,0.15), rgba(201,168,76,0.05));
  border: 1px solid rgba(201,168,76,0.35);
  border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 1rem; color: var(--gold);
  box-shadow: 0 0 18px rgba(201,168,76,0.15);
}

.brand-name {
  font-family: 'DM Serif Display', serif;
  font-size: 1.35rem;
  background: linear-gradient(135deg, #fff 20%, var(--gold2) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}

.nav-center { display: flex; align-items: center; gap: 0.4rem; }

.chip {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.64rem; letter-spacing: 0.07em;
  padding: 0.28rem 0.8rem; border-radius: 999px;
  border: 1px solid var(--border); color: var(--text2);
}
.chip.lit { border-color: rgba(201,168,76,0.4); color: var(--gold2); background: rgba(201,168,76,0.08); }

.srv {
  display: flex; align-items: center; gap: 0.5rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.64rem; color: var(--text2);
  padding: 0.35rem 0.9rem;
  border: 1px solid var(--border); border-radius: 999px;
  transition: all 0.4s;
}
.srv.online { border-color: rgba(52,211,153,0.35); color: #6ee7b7; }

.srv-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text3); transition: all 0.5s; }
.srv-dot.on { background: var(--green); box-shadow: 0 0 7px rgba(52,211,153,0.7); animation: pulse 2s ease-in-out infinite; }

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.45} }

.hero { padding: 4.5rem 0 3rem; text-align: center; }

.eyebrow {
  display: inline-flex; align-items: center; gap: 0.55rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem; letter-spacing: 0.13em; text-transform: uppercase;
  color: var(--gold); border: 1px solid rgba(201,168,76,0.25);
  background: rgba(201,168,76,0.06); padding: 0.4rem 1rem;
  border-radius: 999px; margin-bottom: 1.8rem;
}
.eyebrow-dot { width:5px;height:5px;border-radius:50%;background:var(--gold);box-shadow:0 0 8px var(--gold);animation:pulse 2s ease-in-out infinite; }

.hero-title {
  font-family: 'DM Serif Display', serif;
  font-size: clamp(2.6rem, 5.5vw, 4.6rem);
  line-height: 1.1; letter-spacing: -0.025em;
  margin-bottom: 1.3rem; max-width: 820px;
  margin-left: auto; margin-right: auto;
}

.hero-title em {
  font-style: italic;
  background: linear-gradient(135deg, var(--gold) 0%, var(--gold2) 55%, #fff 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}

.hero-sub { font-size: 0.98rem; color: var(--text2); font-weight: 300; max-width: 460px; margin: 0 auto 2.2rem; line-height: 1.75; }

.hero-tags {
  display: flex; align-items: center; justify-content: center;
  flex-wrap: wrap; gap: 1.5rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem; color: var(--text3); letter-spacing: 0.04em;
}
.hero-tags span { color: var(--text2); }
.htag { display:flex;align-items:center;gap:0.45rem; }

.editor-shell {
  border-radius: 18px; overflow: hidden;
  border: 1px solid var(--border);
  background: var(--border);
  display: grid; grid-template-columns: 1fr 1fr; gap: 1px;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.02), 0 50px 100px rgba(0,0,0,0.55), 0 0 80px rgba(96,165,250,0.04);
}

@media(max-width: 820px) { .editor-shell { grid-template-columns: 1fr; } }

.pane { background: var(--bg3); display: flex; flex-direction: column; }

.pane-top {
  display: flex; align-items: center; gap: 0.7rem;
  padding: 0.85rem 1.3rem;
  background: var(--bg2); border-bottom: 1px solid var(--border);
}

.dots { display:flex;gap:5px; }
.dot { width:10px;height:10px;border-radius:50%;opacity:.85; }
.dr{background:#ff5f57}.dy{background:#ffbd2e}.dg{background:#28c840}

.pane-fname { flex:1; font-family:'JetBrains Mono',monospace; font-size:0.68rem; letter-spacing:0.04em; color: var(--text3); text-transform: uppercase; }

.tag { font-family:'JetBrains Mono',monospace; font-size:0.6rem; padding:0.2rem 0.6rem; border-radius:4px; border:1px solid; }
.tag-java { color:#7dd3fc; border-color:rgba(125,211,252,0.2); background:rgba(125,211,252,0.05); }
.tag-ai   { color:var(--gold); border-color:rgba(201,168,76,0.25); background:rgba(201,168,76,0.06); }

.btn-copy {
  font-family:'JetBrains Mono',monospace; font-size:0.6rem;
  padding:0.2rem 0.65rem; border-radius:4px;
  border:1px solid var(--bh); background:transparent;
  color:var(--text2); cursor:pointer; transition:all 0.2s; display:none;
}
.btn-copy:hover { color:var(--gold); border-color:rgba(201,168,76,0.45); background:rgba(201,168,76,0.07); }

.code-area {
  flex:1; display:flex; overflow: hidden;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem; line-height: 1.85;
  min-height: 500px;
}

.line-nums {
  width: 46px; flex-shrink: 0;
  background: rgba(0,0,0,0.2);
  border-right: 1px solid var(--border);
  padding: 1.3rem 0;
  text-align: right;
  font-size: 0.68rem; line-height: 1.85;
  color: var(--text3);
  user-select: none; overflow: hidden;
  display: flex; flex-direction: column;
}
.line-nums span { display: block; padding-right: 10px; min-height: 1.85em; }

.code-input-wrap { flex:1; position:relative; display:flex; }

textarea {
  flex:1; width:100%;
  background: transparent;
  border: none; outline: none; resize: none;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem; line-height: 1.85;
  color: #e2e8f5;
  padding: 1.3rem 1.3rem 1.3rem 1rem;
  tab-size: 2; caret-color: var(--gold);
  white-space: pre; overflow-wrap: normal; overflow-x: auto;
}
textarea::placeholder { color: #252840; }

.highlight-output {
  flex:1; overflow: auto;
  padding: 1.3rem 1.3rem 1.3rem 1rem;
  white-space: pre; word-break: normal;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem; line-height: 1.85;
}
.highlight-output.empty { color: #252840; font-style: italic; white-space: pre-wrap; }

.kw  { color: #c792ea; font-weight: 500; }
.ty  { color: #82aaff; }
.str { color: #c3e88d; }
.num { color: #f78c6c; }
.cmt { color: #546e7a; font-style: italic; }
.ann { color: #ffcb6b; }

::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #1e2240; border-radius: 99px; }
::-webkit-scrollbar-thumb:hover { background: #2e3460; }

.pane-bot {
  display:flex; align-items:center; gap:0.6rem;
  padding:0.55rem 1.3rem;
  background: var(--bg2); border-top: 1px solid var(--border);
  font-family:'JetBrains Mono',monospace; font-size:0.62rem; color:var(--text3);
}

.ldot { width:5px;height:5px;border-radius:50%;background:var(--text3);flex-shrink:0;transition:all .3s; }
.ldot.on { background:var(--gold); box-shadow:0 0 7px var(--gold); animation:pulse 1.4s ease-in-out infinite; }

.actions { display:flex; align-items:center; justify-content:center; gap:0.9rem; padding:1.8rem 0; }

.btn-clear {
  font-family:'Outfit',sans-serif; font-weight:500; font-size:0.85rem;
  padding:0.8rem 1.5rem; border-radius:10px;
  border:1px solid var(--border); background:transparent;
  color:var(--text2); cursor:pointer; transition:all .2s;
}
.btn-clear:hover { border-color:var(--bh); color:var(--text); background:rgba(255,255,255,0.03); }

.btn-main {
  position:relative; overflow:hidden;
  font-family:'Outfit',sans-serif; font-weight:700; font-size:0.95rem;
  padding:0.88rem 2.5rem; border-radius:10px; border:none; cursor:pointer;
  background:linear-gradient(135deg, #a07830 0%, var(--gold2) 45%, #c8a045 100%);
  color:#06040a;
  display:flex; align-items:center; gap:0.6rem;
  box-shadow: 0 0 32px rgba(201,168,76,0.28), 0 4px 24px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.22);
  transition:all .25s;
}
.btn-main::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(255,255,255,.18),transparent); opacity:0; transition:opacity .2s; }
.btn-main:hover::before { opacity:1; }
.btn-main:hover { transform:translateY(-2px); box-shadow:0 0 55px rgba(201,168,76,.42), 0 8px 32px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.22); }
.btn-main:active { transform:none; }
.btn-main:disabled { opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

.spin { width:15px; height:15px; border:2px solid rgba(0,0,0,.18); border-top-color:#06040a; border-radius:50%; animation:rot .65s linear infinite; display:none; flex-shrink:0; }
@keyframes rot { to { transform:rotate(360deg); } }

.kbd { display:flex;align-items:center;gap:.35rem;font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--text3); }
kbd { background:var(--bg2);border:1px solid var(--bh);border-radius:4px;padding:.12rem .4rem;font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--text2); }

.imp { display:none; margin-bottom:2.5rem; animation:up .4s cubic-bezier(.16,1,.3,1); }
.imp.show { display:block; }
@keyframes up { from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:none} }

.imp-card { background:var(--bg3); border:1px solid var(--border); border-left: 2px solid rgba(201,168,76,0.5); border-radius:14px; overflow:hidden; box-shadow:0 20px 50px rgba(0,0,0,.3); }
.imp-hdr { display:flex;align-items:center;gap:.7rem; padding:1rem 1.4rem; background:var(--bg2); border-bottom:1px solid var(--border); }
.imp-ico { width:26px;height:26px;border-radius:6px; background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.25); display:flex;align-items:center;justify-content:center; font-size:.75rem;color:var(--gold); }
.imp-hdr h3 { font-family:'JetBrains Mono',monospace;font-size:.68rem; letter-spacing:.1em;text-transform:uppercase;color:var(--gold);font-weight:400; }
.imp-body { padding:1.4rem; font-family:'JetBrains Mono',monospace;font-size:.76rem; color:var(--text2); line-height:1.95; white-space:pre-wrap; }

.err { display:none;align-items:center;gap:.7rem; background:rgba(255,107,107,.07);border:1px solid rgba(255,107,107,.22); border-radius:10px;padding:.9rem 1.3rem; margin-bottom:1.4rem;font-size:.83rem;color:#fca5a5; animation:up .3s ease; }
.err.show { display:flex; }

footer { border-top:1px solid var(--border); padding:1.8rem 0; margin-top:1.5rem; }
.foot { display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem; }
.foot-brand { font-family:'DM Serif Display',serif;font-size:.95rem; background:linear-gradient(135deg,#fff 0%,var(--gold2) 100%); -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text; }
.foot-info { font-family:'JetBrains Mono',monospace;font-size:.62rem; color:var(--text3);text-align:right;line-height:1.9; }
.foot-info span { color:var(--text2); }
.divider { height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:.5rem 0; }
</style>
</head>
<body>

<div class="amb amb-1"></div>
<div class="amb amb-2"></div>
<div class="amb amb-3"></div>

<header>
  <div class="wrap">
    <nav class="nav">
      <a class="brand" href="#">
        <div class="brand-icon">&lt;/&gt;</div>
        <span class="brand-name">CodeRefine</span>
      </a>
      <div class="nav-center">
        <span class="chip lit">Editor</span>
        <span class="chip">Any Language → Java</span>
        <span class="chip">LLaMA 3.3 · 70B</span>
      </div>
      <div class="srv" id="srv">
        <div class="srv-dot" id="srvDot"></div>
        <span id="srvLabel">Connecting…</span>
      </div>
    </nav>
  </div>
</header>

<div class="wrap">

  <section class="hero">
    <div class="eyebrow"><div class="eyebrow-dot"></div>AI-Powered Code Optimization</div>
    <h1 class="hero-title">Turn raw code into<br><em>production-grade</em> masterwork.</h1>
    <p class="hero-sub">Paste code in any language. Our AI refactors it into clean, optimized, professional-grade Java.</p>
    <div class="hero-tags">
      <div class="htag">⬡ <span>Clean Code</span></div>
      <div class="htag">◈ <span>Big-O Optimization</span></div>
      <div class="htag">◎ <span>OOP Patterns</span></div>
      <div class="htag">✦ <span>Groq · Ultra-Fast</span></div>
    </div>
  </section>

  <div class="err" id="errBox">
    <span>⚠</span><span id="errMsg">Cannot reach server at localhost:8080.</span>
  </div>

  <section style="margin-bottom:0">
    <div class="editor-shell">

      <div class="pane">
        <div class="pane-top">
          <div class="dots"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div></div>
          <span class="pane-fname">input — any language</span>
          <span class="tag tag-java">Input</span>
        </div>
        <div class="code-area">
          <div class="line-nums" id="lineNums"><span>1</span></div>
          <div class="code-input-wrap">
            <textarea id="codeIn" spellcheck="false"
              placeholder="// Paste any language code here&#10;// Python, C++, JS, C#, etc.&#10;// Press Ctrl+Enter to refine&#10;&#10;def bubble_sort(arr):&#10;    for i in range(len(arr)):&#10;        for j in range(len(arr)-1):&#10;            if arr[j] > arr[j+1]:&#10;                arr[j], arr[j+1] = arr[j+1], arr[j]"></textarea>
          </div>
        </div>
        <div class="pane-bot">
          <div class="ldot" id="inDot"></div>
          <span id="chars">0 chars</span>
          <span style="flex:1"></span>
          <span id="lines">0 lines</span>
        </div>
      </div>

      <div class="pane">
        <div class="pane-top">
          <div class="dots"><div class="dot dr"></div><div class="dot dy"></div><div class="dot dg"></div></div>
          <span class="pane-fname">output.java</span>
          <button class="btn-copy" id="cpyBtn" onclick="doCopy()">⎘ Copy</button>
          <span class="tag tag-ai">AI Refined</span>
        </div>
        <div class="code-area">
          <div class="line-nums" id="outLineNums"><span>1</span></div>
          <div class="code-input-wrap">
            <div class="highlight-output empty" id="codeOut">// Your refined Java code will appear here...
//
// The AI will:
//   → Convert any language to Java
//   → Apply clean code principles
//   → Optimize time & space complexity
//   → Add professional Javadoc
//   → Refactor structure & naming
//   → Handle edge cases</div>
          </div>
        </div>
        <div class="pane-bot">
          <div class="ldot" id="outDot"></div>
          <span id="outStatus">Waiting for input</span>
          <span style="flex:1"></span>
          <span id="outLines"></span>
        </div>
      </div>

    </div>
  </section>

  <div class="actions">
    <button class="btn-clear" onclick="doClear()">✕ Clear</button>
    <button class="btn-main" id="mainBtn" onclick="doRefine()">
      <span id="btnIco">✦</span>
      <span id="btnTxt">Refine Code</span>
      <div class="spin" id="spin"></div>
    </button>
    <div class="kbd"><kbd>Ctrl</kbd>+<kbd>Enter</kbd></div>
  </div>

  <div class="imp" id="impPanel">
    <div class="imp-card">
      <div class="imp-hdr">
        <div class="imp-ico">✦</div>
        <h3>Improvements Applied</h3>
      </div>
      <div class="imp-body" id="impBody"></div>
    </div>
  </div>

  <div class="divider"></div>
</div>

<footer>
  <div class="wrap">
    <div class="foot">
      <span class="foot-brand">CodeRefine</span>
      <div class="foot-info">
        <div>Endpoint · <span>localhost:8080/refine</span></div>
        <div>Model · <span>LLaMA 3.3 · 70B via Groq</span></div>
      </div>
    </div>
  </div>
</footer>

<script>
const G = id => document.getElementById(id);
const codeIn      = G('codeIn');
const codeOut     = G('codeOut');
const mainBtn     = G('mainBtn');
const spin        = G('spin');
const btnIco      = G('btnIco');
const btnTxt      = G('btnTxt');
const chars       = G('chars');
const lines       = G('lines');
const outStatus   = G('outStatus');
const outLines    = G('outLines');
const outDot      = G('outDot');
const inDot       = G('inDot');
const srvDot      = G('srvDot');
const srvLabel    = G('srvLabel');
const srv         = G('srv');
const errBox      = G('errBox');
const errMsg      = G('errMsg');
const cpyBtn      = G('cpyBtn');
const impPanel    = G('impPanel');
const impBody     = G('impBody');
const lineNums    = G('lineNums');
const outLineNums = G('outLineNums');

function highlight(code) {
  if (!code) return '';
  let h = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const patterns = [
    { re: /\/\/[^\n]*/g, cls: 'cmt' },
    { re: /\/\*[\s\S]*?\*\//g, cls: 'cmt' },
    { re: /"(?:[^"\\]|\\.)*"/g, cls: 'str' },
    { re: /'(?:[^'\\]|\\.)*'/g, cls: 'str' },
    { re: /@\w+/g, cls: 'ann' },
    { re: /\b(abstract|assert|break|case|catch|class|const|continue|default|do|else|enum|extends|final|finally|for|goto|if|implements|import|instanceof|interface|native|new|package|private|protected|public|record|return|sealed|static|strictfp|super|switch|synchronized|this|throw|throws|transient|try|var|void|volatile|while)\b/g, cls:'kw'},
    { re: /\b(boolean|byte|char|double|float|int|long|short|String|Integer|Double|Float|Long|Boolean|Object|List|Map|Set|Optional|Stream|Arrays|Collections|System|Math|StringBuilder|Exception|RuntimeException|ArrayList|HashMap|LinkedList|Iterator)\b/g, cls:'ty'},
    { re: /\b\d+\.?\d*[fFdDlL]?\b/g, cls: 'num' },
  ];
  const combined = new RegExp(patterns.map(p => `(${p.re.source})`).join('|'), 'gm');
  let result = '', lastIndex = 0, match;
  combined.lastIndex = 0;
  while ((match = combined.exec(h)) !== null) {
    if (match.index > lastIndex) result += h.slice(lastIndex, match.index);
    for (let g = 0; g < patterns.length; g++) {
      if (match[g + 1] !== undefined) {
        result += `<span class="${patterns[g].cls}">${match[g+1]}</span>`;
        break;
      }
    }
    lastIndex = match.index + match[0].length;
  }
  result += h.slice(lastIndex);
  return result;
}

function renderLineNums(container, count) {
  container.innerHTML = Array.from({length: Math.max(count,1)}, (_,i) =>
    `<span>${i+1}</span>`).join('');
}

codeIn.addEventListener('input', () => {
  const v = codeIn.value;
  const lc = v ? v.split('\n').length : 0;
  chars.textContent = v.length.toLocaleString() + ' chars';
  lines.textContent = lc + ' lines';
  inDot.classList.toggle('on', v.length > 0);
  renderLineNums(lineNums, lc);
});

codeIn.addEventListener('scroll', () => { lineNums.scrollTop = codeIn.scrollTop; });

async function ping() {
  try {
    const ac = new AbortController();
    setTimeout(() => ac.abort(), 2500);
    await fetch('http://localhost:8080/refine', { method:'OPTIONS', signal:ac.signal });
    srvDot.className = 'srv-dot on';
    srvLabel.textContent = 'Server Online';
    srv.className = 'srv online';
  } catch {
    srvDot.className = 'srv-dot';
    srvLabel.textContent = 'Server Offline';
    srv.className = 'srv';
  }
}
ping(); setInterval(ping, 8000);

function setLoading(on) {
  mainBtn.disabled = on;
  spin.style.display = on ? 'block' : 'none';
  btnIco.style.display = on ? 'none' : 'inline';
  btnTxt.textContent = on ? 'Refining…' : 'Refine Code';
  outDot.classList.toggle('on', on);
  outStatus.textContent = on ? 'AI is analyzing…' : 'Ready';
}

async function doRefine() {
  const code = codeIn.value.trim();
  if (!code) { codeIn.focus(); return; }

  setLoading(true);
  errBox.className = 'err';
  impPanel.className = 'imp';
  codeOut.innerHTML = '<span class="cmt">// Analyzing and refining your code…\n// This usually takes 3–8 seconds.</span>';
  codeOut.className = 'highlight-output';
  cpyBtn.style.display = 'none';
  outLines.textContent = '';
  renderLineNums(outLineNums, 2);

  try {
    const res = await fetch('http://localhost:8080/refine', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });

    if (!res.ok) throw new Error('Server responded ' + res.status);

    const data = await res.json();
    const raw  = data.result || '';

    const marker = '-----IMPROVEMENTS MADE-----';
    const idx    = raw.indexOf(marker);
    const codeSection = (idx !== -1 ? raw.slice(0, idx) : raw).trim();
    const impSection  = idx !== -1 ? raw.slice(idx + marker.length).trim() : '';

    codeOut.innerHTML = highlight(codeSection);
    codeOut.className = 'highlight-output';

    const lc = codeSection.split('\n').length;
    renderLineNums(outLineNums, lc);
    outLines.textContent = lc + ' lines';
    outStatus.textContent = 'Refinement complete ✓';
    outDot.classList.remove('on');
    cpyBtn.style.display = 'block';
    srvDot.className = 'srv-dot on';
    srvLabel.textContent = 'Server Online';
    srv.className = 'srv online';

    if (impSection) {
      impBody.textContent = impSection;
      impPanel.className = 'imp show';
    }

  } catch (err) {
    const msg = (err.message.includes('fetch') || err.message.includes('Failed'))
      ? 'Cannot reach server at localhost:8080. Make sure your Java server is running.'
      : 'Error: ' + err.message;
    errMsg.textContent = msg;
    errBox.className = 'err show';
    codeOut.innerHTML = '<span class="cmt">// Refinement failed.\n// Check that your Java server is running on port 8080.</span>';
    codeOut.className = 'highlight-output';
    outStatus.textContent = 'Failed';
    srvDot.className = 'srv-dot';
    srvLabel.textContent = 'Server Offline';
    srv.className = 'srv';
    renderLineNums(outLineNums, 2);
  } finally {
    setLoading(false);
  }
}

function doCopy() {
  const text = codeOut.innerText || codeOut.textContent;
  navigator.clipboard.writeText(text).then(() => {
    cpyBtn.textContent = '✓ Copied!';
    setTimeout(() => cpyBtn.textContent = '⎘ Copy', 2000);
  });
}

function doClear() {
  codeIn.value = '';
  codeOut.innerHTML = '// Your refined Java code will appear here...\n//\n// The AI will:\n//   \u2192 Convert any language to Java\n//   \u2192 Apply clean code principles\n//   \u2192 Optimize time &amp; space complexity\n//   \u2192 Add professional Javadoc\n//   \u2192 Refactor structure &amp; naming\n//   \u2192 Handle edge cases';
  codeOut.className = 'highlight-output empty';
  chars.textContent = '0 chars';
  lines.textContent = '0 lines';
  outStatus.textContent = 'Waiting for input';
  outLines.textContent = '';
  errBox.className = 'err';
  impPanel.className = 'imp';
  cpyBtn.style.display = 'none';
  inDot.classList.remove('on');
  outDot.classList.remove('on');
  renderLineNums(lineNums, 1);
  renderLineNums(outLineNums, 1);
}

codeIn.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); doRefine(); }
  if (e.key === 'Tab') {
    e.preventDefault();
    const s = codeIn.selectionStart;
    codeIn.value = codeIn.value.slice(0,s) + '  ' + codeIn.value.slice(codeIn.selectionEnd);
    codeIn.selectionStart = codeIn.selectionEnd = s + 2;
  }
});
</script>
</body>
</html>

